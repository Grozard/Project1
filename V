"""
–ü–†–û–ï–ö–¢: –î–ù–ï–í–ù–ò–ö –ö–ò–ù–û–ú–ê–ù–ê (MOVIE TRACKER)
–ü–æ–ª–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –∫–∏–Ω–æ-–¥–Ω–µ–≤–Ω–∏–∫–∞.
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL
"""

import psycopg2
from psycopg2 import OperationalError
import json
from datetime import datetime

# ============================================
# –ß–ê–°–¢–¨ –í: –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•
# ============================================

# –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø - –ò–ó–ú–ï–ù–ò –ü–ê–†–û–õ–¨ –ù–ê –°–í–û–ô!
DB_CONFIG = {
    "database": "movie_db",
    "user": "postgres",
    "password": "your_password",  # <--- –í–í–ï–î–ò –°–í–û–ô –ü–ê–†–û–õ–¨ –ó–î–ï–°–¨!
    "host": "localhost",
    "port": "5432"
}

def connect_db():
    """–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        print("‚úÖ –ë–∞–∑–∞ —Ñ–∏–ª—å–º–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        return conn
    except OperationalError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: 1) –ó–∞–ø—É—â–µ–Ω –ª–∏ PostgreSQL 2) –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –ø–∞—Ä–æ–ª—å")
        return None

# ============================================
# –ß–ê–°–¢–¨ –°: –û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
# ============================================

def add_movie(conn, title, date, duration, rating, genre, review):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π —Ñ–∏–ª—å–º.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –∑–∞–ø–∏—Å–∏.
    """
    try:
        cursor = conn.cursor()
        
        # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é
        if not date:
            date = datetime.now().strftime('%Y-%m-%d')
        
        sql = """
            INSERT INTO movie_logs (title, watch_date, duration_min, rating, genre, review)
            VALUES (%s, %s, %s, %s, %s, %s)
            RETURNING id;
        """
        cursor.execute(sql, (title, date, duration, rating, genre, review))
        movie_id = cursor.fetchone()[0]
        conn.commit()
        cursor.close()
        
        # –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏–Ω–æ-–º–∞—Ä–∞—Ñ–æ–Ω
        check_marathon(conn, date)
        
        print(f"‚úÖ –§–∏–ª—å–º '{title}' –¥–æ–±–∞–≤–ª–µ–Ω —Å ID: {movie_id}")
        return movie_id
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞: {e}")
        conn.rollback()
        return None

def get_all_movies(conn):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ).
    """
    try:
        cursor = conn.cursor()
        sql = """
            SELECT id, title, watch_date, duration_min, rating, genre, review 
            FROM movie_logs 
            ORDER BY watch_date DESC;
        """
        cursor.execute(sql)
        movies = cursor.fetchall()
        cursor.close()
        return movies
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª—å–º–æ–≤: {e}")
        return []

def search_by_title(conn, movie_title):
    """
    –ò—â–µ—Ç —Ñ–∏–ª—å–º—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞).
    """
    try:
        cursor = conn.cursor()
        sql = """
            SELECT id, title, watch_date, rating 
            FROM movie_logs 
            WHERE title ILIKE %s 
            ORDER BY watch_date DESC;
        """
        cursor.execute(sql, ('%' + movie_title + '%',))
        movies = cursor.fetchall()
        cursor.close()
        return movies
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {e}")
        return []

def filter_by_rating(conn, min_rating):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–ª—å–º—ã —Å –æ—Ü–µ–Ω–∫–æ–π –Ω–µ –Ω–∏–∂–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π.
    """
    try:
        cursor = conn.cursor()
        sql = """
            SELECT id, title, watch_date, rating 
            FROM movie_logs 
            WHERE rating >= %s 
            ORDER BY rating DESC;
        """
        cursor.execute(sql, (min_rating,))
        movies = cursor.fetchall()
        cursor.close()
        return movies
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {e}")
        return []

def update_movie(conn, log_id, new_rating, new_review):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É –∏ –æ—Ç–∑—ã–≤ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏.
    """
    try:
        cursor = conn.cursor()
        sql = "UPDATE movie_logs SET rating = %s, review = %s WHERE id = %s;"
        cursor.execute(sql, (new_rating, new_review, log_id))
        conn.commit()
        cursor.close()
        print(f"‚úÖ –ó–∞–ø–∏—Å—å —Å ID {log_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
        conn.rollback()
        return False

def delete_movie(conn, log_id):
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ ID.
    """
    try:
        cursor = conn.cursor()
        sql = "DELETE FROM movie_logs WHERE id = %s;"
        cursor.execute(sql, (log_id,))
        conn.commit()
        cursor.close()
        print(f"‚úÖ –ó–∞–ø–∏—Å—å —Å ID {log_id} —É–¥–∞–ª–µ–Ω–∞.")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")
        conn.rollback()
        return False

def get_cinema_stats(conn):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
    - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
    - —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
    - –æ–±—â–µ–µ –≤—Ä–µ–º—è, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –Ω–∞ –∫–∏–Ω–æ (–≤ —á–∞—Å–∞—Ö)
    - —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∂–∞–Ω—Ä
    """
    stats = {}
    try:
        cursor = conn.cursor()
        
        # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
        cursor.execute("SELECT COUNT(*), AVG(rating) FROM movie_logs;")
        count, avg_rating = cursor.fetchone()
        stats['total_movies'] = count
        stats['average_rating'] = round(avg_rating, 2) if avg_rating else 0
        
        # –û–±—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–∞—Ö
        cursor.execute("SELECT SUM(duration_min) FROM movie_logs;")
        total_minutes = cursor.fetchone()[0]
        stats['total_hours'] = round(total_minutes / 60, 2) if total_minutes else 0
        
        # –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∂–∞–Ω—Ä
        cursor.execute("""
            SELECT genre, COUNT(*) as count
            FROM movie_logs
            GROUP BY genre
            ORDER BY count DESC
            LIMIT 1;
        """)
        result = cursor.fetchone()
        stats['most_popular_genre'] = result[0] if result else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
        
        cursor.close()
        return stats
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        return {}

# ============================================
# –ß–ê–°–¢–¨ –ï: –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ó–ê–î–ê–ù–ò–Ø
# ============================================

def get_genre_rating(conn):
    """
    –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 1: –¢–æ–ø –∂–∞–Ω—Ä–æ–≤ - —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∂–∞–Ω—Ä–∞.
    """
    try:
        cursor = conn.cursor()
        sql = """
            SELECT genre, AVG(rating) as avg_rating, COUNT(*) as count
            FROM movie_logs
            GROUP BY genre
            ORDER BY avg_rating DESC;
        """
        cursor.execute(sql)
        genres = cursor.fetchall()
        cursor.close()
        return genres
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∂–∞–Ω—Ä–∞–º: {e}")
        return []

def export_to_json(conn):
    """
    –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 2: –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ JSON —Ñ–∞–π–ª.
    """
    try:
        cursor = conn.cursor()
        sql = "SELECT id, title, watch_date, duration_min, rating, genre, review FROM movie_logs ORDER BY watch_date DESC;"
        cursor.execute(sql)
        movies = cursor.fetchall()
        cursor.close()
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è JSON
        movies_list = []
        for movie in movies:
            movies_list.append({
                'id': movie[0],
                'title': movie[1],
                'watch_date': str(movie[2]),  # date –≤ —Å—Ç—Ä–æ–∫—É
                'duration_min': movie[3],
                'rating': movie[4],
                'genre': movie[5],
                'review': movie[6]
            })
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        filename = f'collection_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(movies_list, f, ensure_ascii=False, indent=4)
        
        print(f"‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(movies_list)} —Ñ–∏–ª—å–º–æ–≤ –≤ —Ñ–∞–π–ª {filename}")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: {e}")
        return False

def check_marathon(conn, watch_date):
    """
    –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏–Ω–æ-–º–∞—Ä–∞—Ñ–æ–Ω (–±–æ–ª–µ–µ 3 —Ñ–∏–ª—å–º–æ–≤ –∑–∞ –¥–µ–Ω—å).
    """
    try:
        cursor = conn.cursor()
        sql = "SELECT COUNT(*) FROM movie_logs WHERE watch_date = %s;"
        cursor.execute(sql, (watch_date,))
        count = cursor.fetchone()[0]
        cursor.close()
        
        if count >= 3:
            print(f"‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ö–∏–Ω–æ-–º–∞—Ä–∞—Ñ–æ–Ω! –°–µ–≥–æ–¥–Ω—è ({watch_date}) —Ç—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∞ —É–∂–µ {count} —Ñ–∏–ª—å–º–æ–≤!")
        return count
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞: {e}")
        return 0

# ============================================
# –ß–ê–°–¢–¨ D: –ö–û–ù–°–û–õ–¨–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–°
# ============================================

def display_movies(movies, detailed=False):
    """
    –ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤.
    """
    if not movies:
        print("üçø –ü–æ—Ä–∞ –Ω–∞—á–∞—Ç—å —Å–º–æ—Ç—Ä–µ—Ç—å –∫–∏–Ω–æ!")
        return
    
    print("\n" + "-" * 80)
    for movie in movies:
        if detailed and len(movie) >= 7:
            # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
            print(f"ID: {movie[0]} | {movie[1]} ({movie[2]})")
            print(f"   –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {movie[3]} –º–∏–Ω | –û—Ü–µ–Ω–∫–∞: {movie[4]}/10 | –ñ–∞–Ω—Ä: {movie[5]}")
            print(f"   –û—Ç–∑—ã–≤: {movie[6] if movie[6] else '–ù–µ—Ç –æ—Ç–∑—ã–≤–∞'}")
            print("-" * 40)
        elif len(movie) >= 4:
            # –ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥
            print(f"ID: {movie[0]} | {movie[1]} ({movie[2]}) - –û—Ü–µ–Ω–∫–∞: {movie[3]}/10")
    print("-" * 80)

def get_valid_input(prompt, input_type='str', valid_range=None, allow_empty=False):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–≤–æ–¥–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π.
    """
    while True:
        user_input = input(prompt).strip()
        
        if allow_empty and user_input == '':
            return None
            
        try:
            if input_type == 'int':
                value = int(user_input)
                if valid_range:
                    if value < valid_range[0] or value > valid_range[1]:
                        print(f"‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç {valid_range[0]} –¥–æ {valid_range[1]}.")
                        continue
                return value
            elif input_type == 'float':
                value = float(user_input)
                if valid_range:
                    if value < valid_range[0] or value > valid_range[1]:
                        print(f"‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç {valid_range[0]} –¥–æ {valid_range[1]}.")
                        continue
                return value
            else:  # str
                if not user_input and not allow_empty:
                    print("‚ùå –ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
                    continue
                return user_input
        except ValueError:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ {input_type}.")

def main_menu():
    """
    –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –º–µ–Ω—é.
    """
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ
    conn = connect_db()
    if not conn:
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        return
    
    while True:
        print("\n" + "=" * 50)
        print("            üé¨ –î–ù–ï–í–ù–ò–ö –ö–ò–ù–û–ú–ê–ù–ê üé¨")
        print("=" * 50)
        print("1.  ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º")
        print("2.  üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ñ–∏–ª—å–º—ã")
        print("3.  üîç –ù–∞–π—Ç–∏ —Ñ–∏–ª—å–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é")
        print("4.  ‚≠ê –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–æ—Ç –∏ –≤—ã—à–µ)")
        print("5.  ‚úèÔ∏è  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ü–µ–Ω–∫—É/–æ—Ç–∑—ã–≤")
        print("6.  üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å")
        print("7.  üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
        print("8.  üìà –¢–æ–ø –∂–∞–Ω—Ä–æ–≤ (—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞)")  # –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 1
        print("9.  üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON")                # –î–æ–ø. –∑–∞–¥–∞–Ω–∏–µ 2
        print("0.  üö™ –í—ã—Ö–æ–¥")
        print("=" * 50)
        
        choice = get_valid_input("–í–∞—à –≤—ã–±–æ—Ä: ", input_type='int', valid_range=(0, 9))
        
        if choice == 1:
            print("\n--- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞ ---")
            title = get_valid_input("–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞: ")
            date = get_valid_input("–î–∞—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–ì–ì–ì–ì-–ú–ú-–î–î, Enter - —Å–µ–≥–æ–¥–Ω—è): ", allow_empty=True)
            duration = get_valid_input("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω): ", input_type='int', valid_range=(1, 1000))
            rating = get_valid_input("–û—Ü–µ–Ω–∫–∞ (1-10): ", input_type='int', valid_range=(1, 10))
            
            print("\n–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä:")
            print("1. –ë–æ–µ–≤–∏–∫")
            print("2. –ö–æ–º–µ–¥–∏—è")
            print("3. –î—Ä–∞–º–∞")
            print("4. –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞")
            print("5. –î—Ä—É–≥–æ–µ")
            genre_choice = get_valid_input("–í–∞—à –≤—ã–±–æ—Ä (1-5): ", input_type='int', valid_range=(1, 5))
            
            genres = ['–ë–æ–µ–≤–∏–∫', '–ö–æ–º–µ–¥–∏—è', '–î—Ä–∞–º–∞', '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', '–î—Ä—É–≥–æ–µ']
            genre = genres[genre_choice - 1]
            
            review = input("–û—Ç–∑—ã–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): ")
            
            add_movie(conn, title, date, duration, rating, genre, review)
        
        elif choice == 2:
            print("\n--- üìã –í—Å–µ —Ñ–∏–ª—å–º—ã (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ) ---")
            movies = get_all_movies(conn)
            display_movies(movies, detailed=True)
        
        elif choice == 3:
            print("\n--- üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é ---")
            search_term = get_valid_input("–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è: ")
            results = search_by_title(conn, search_term)
            display_movies(results)
        
        elif choice == 4:
            print("\n--- ‚≠ê –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É ---")
            min_rating = get_valid_input("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (1-10): ", input_type='int', valid_range=(1, 10))
            filtered = filter_by_rating(conn, min_rating)
            display_movies(filtered)
        
        elif choice == 5:
            print("\n--- ‚úèÔ∏è  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ---")
            movie_id = get_valid_input("–í–≤–µ–¥–∏—Ç–µ ID —Ñ–∏–ª—å–º–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ", input_type='int')
            new_rating = get_valid_input("–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (1-10): ", input_type='int', valid_range=(1, 10))
            new_review = input("–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤: ")
            update_movie(conn, movie_id, new_rating, new_review)
        
        elif choice == 6:
            print("\n--- üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ---")
            movie_id = get_valid_input("–í–≤–µ–¥–∏—Ç–µ ID —Ñ–∏–ª—å–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: ", input_type='int')
            
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            confirm = input(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID {movie_id}? (–¥/–Ω): ")
            if confirm.lower() in ['–¥', '–¥–∞', 'y', 'yes']:
                delete_movie(conn, movie_id)
            else:
                print("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        
        elif choice == 7:
            print("\n--- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---")
            stats = get_cinema_stats(conn)
            if stats:
                print(f"üìΩÔ∏è  –í—Å–µ–≥–æ —Ñ–∏–ª—å–º–æ–≤: {stats['total_movies']}")
                print(f"‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {stats['average_rating']}")
                print(f"‚è±Ô∏è  –í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: {stats['total_hours']} —á.")
                print(f"üéØ –õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä: {stats['most_popular_genre']}")
        
        elif choice == 8:
            print("\n--- üìà –¢–æ–ø –∂–∞–Ω—Ä–æ–≤ (—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞) ---")
            genres = get_genre_rating(conn)
            if genres:
                print("\n–ñ–∞–Ω—Ä         | –°—Ä–µ–¥. –æ—Ü–µ–Ω–∫–∞ | –ö–æ–ª-–≤–æ")
                print("-" * 40)
                for genre, avg_rating, count in genres:
                    print(f"{genre:<12} | {avg_rating:.2f}          | {count}")
            else:
                print("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∂–∞–Ω—Ä–∞–º.")
        
        elif choice == 9:
            print("\n--- üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON ---")
            export_to_json(conn)
        
        elif choice == 0:
            print("\nüëã –í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            conn.close()
            break
        
        input("\n–ù–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

# ============================================
# –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ú–´
# ============================================

if __name__ == "__main__":
    print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë     –î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –î–ù–ï–í–ù–ò–ö       ‚ïë
    ‚ïë            –ö–ò–ù–û–ú–ê–ù–ê!                  ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)
    main_menu()
